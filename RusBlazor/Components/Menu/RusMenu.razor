@using RusBlazor.Components.Helpers
@using RusBlazor.Enums
@typeparam T

@inject IJSRuntime JSRuntime

<div class="rus-menu" style="@AnchorStyle()" id="@parentContainerId">
    @if (MenuTopContent != null)
    {
        @MenuTopContent
    }
    <div class="rus-menu-dropdown" id="@id">
        @if (MenuContent != null)
        {
            @MenuContent
        }
    </div>
    @if (MenuBottomContent != null)
    {
        @MenuBottomContent
    }
</div>

@if (IsOpen)
{
    <RusBackgroundOverlay OnClick="Close" />
}


@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public Anchor Anchor { get; set; } = Anchor.Auto;

    [Parameter]
    public RenderFragment? MenuContent { get; set; }

    [Parameter]
    public RenderFragment? MenuTopContent { get; set; }

    [Parameter]
    public RenderFragment? MenuBottomContent { get; set; }

    string id;
    string parentContainerId;
    private bool previousIsOpen;
    int animationDurationMs = 1000;
    int dropdownHeight = 240;

    protected override void OnInitialized()
    {
        id = Guid.NewGuid().ToString();
        parentContainerId = Guid.NewGuid().ToString();
        base.OnInitialized();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen != previousIsOpen && IsOpen == true)
        {
            await JSRuntime.InvokeVoidAsync("toggleDropdownHeight", id, true, dropdownHeight, animationDurationMs);
            await JSRuntime.InvokeVoidAsync("toggleDropdownOpacity", parentContainerId, true, animationDurationMs);

            await IsOpenChanged.InvokeAsync(IsOpen);
        }

        previousIsOpen = IsOpen;

        await base.OnParametersSetAsync();
    }

    string AnchorStyle()
    {
        return Anchor switch
        {
            Anchor.Bottom => "top: 100%; left: 0;",
            Anchor.Top => "bottom: 100%; left: 0;",
            Anchor.Left => "right: 100%; top: 0;",
            Anchor.Right => "left: 100%; top: 0;",
            Anchor.BottomLeft => "top: 100%; right: 0;",
            Anchor.BottomRight => "top: 100%; left: 0;",
            Anchor.TopLeft => "bottom: 100%; right: 0;",
            Anchor.TopRight => "bottom: 100%; left: 0;",
            _ => "top: 100%; left: 0;",
        };
    }

    string StateStyle()
    {
        return IsOpen ? "display:block;" : "display:none;";
    }

    public async Task Close()
    {
        await JSRuntime.InvokeVoidAsync("toggleDropdownHeight", id, false, dropdownHeight, animationDurationMs);
        await JSRuntime.InvokeVoidAsync("toggleDropdownOpacity", parentContainerId, false, animationDurationMs / 2);

        await Task.Delay(animationDurationMs);
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    public string GetId()
    {
        return id;
    }
}