@using HotfixMods.Core.Enums.Db2;
@using HotfixMods.Infrastructure.InfoModels
@using HotfixMods.Infrastructure.Blazor.Components.DtoContent


<InstancedDtoContentPage>
    <CustomDtoContent InstancedContent="true">
        <MudItem xs="3">
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet1.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet1))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet1Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet1.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet1Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet2.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet2))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet2Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet2.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet2Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet3.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet3))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet3Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet3.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet3Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet4.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet4))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet4Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet4.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet4Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
        </MudItem>
        <MudItem xs="6" />
                <MudItem xs="3">
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet5.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet5))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet5Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet5.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet5Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet6.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet6))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet6Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet6.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet6Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet7.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet7))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet7Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet7.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet7Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" Value="@(animKitConfigBoneSet8.AnimKitBoneSetID)" ValueChanged="@((byte newValue) => ValueChanged(newValue, animKitConfigBoneSet8))" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet8Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="GetAnimKitBoneSets" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" @bind-Value="@(animKitConfigBoneSet8.AnimKitPriorityID)" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet8Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetAnimKitPriorities" />
                </RightContent>
            </InlineGroup>
        </MudItem>
    </CustomDtoContent>
</InstancedDtoContentPage>

@code {
    [CascadingParameter(Name = "InstanceData")]
    public InstanceData? InstanceData { get; set; }

    [CascadingParameter(Name = "GroupIndex")]
    public int GroupIndex { get; set; }

    [CascadingParameter(Name = "PageTab")]
    public PageTab PageTab { get; set; }

    [CascadingParameter(Name = "ValueIsNull")]
    public bool ValueIsNull { get; set; }

    bool valuesExists = false;
    AnimKitConfigBoneSetInfo info = new();

    AnimKitConfigBoneSet animKitConfigBoneSet1;
    AnimKitConfigBoneSet animKitConfigBoneSet2;
    AnimKitConfigBoneSet animKitConfigBoneSet3;
    AnimKitConfigBoneSet animKitConfigBoneSet4;
    AnimKitConfigBoneSet animKitConfigBoneSet5;
    AnimKitConfigBoneSet animKitConfigBoneSet6;
    AnimKitConfigBoneSet animKitConfigBoneSet7;
    AnimKitConfigBoneSet animKitConfigBoneSet8;

    AnimKitConfigBoneSet? animKitConfigBoneSet1Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet2Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet3Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet4Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet5Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet6Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet7Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet8Compare;

    protected override void OnParametersSet()
    {
        var groupValue = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);
        valuesExists = groupValue != null;
        if (valuesExists)
            SetValues();
        base.OnParametersSet();
    }

    void SetValues()
    {
        animKitConfigBoneSet1 = SetAndGetValue(0);
        animKitConfigBoneSet2 = SetAndGetValue(1);
        animKitConfigBoneSet3 = SetAndGetValue(2);
        animKitConfigBoneSet4 = SetAndGetValue(3);
        animKitConfigBoneSet5 = SetAndGetValue(4);
        animKitConfigBoneSet6 = SetAndGetValue(5);
        animKitConfigBoneSet7 = SetAndGetValue(6);
        animKitConfigBoneSet8 = SetAndGetValue(7);

        if (PageTab.DtoCompare != null)
        {
            var valueCompareList = PageTab.DtoCompare.GetDtoListValue<AnimKitConfigBoneSet>();
            animKitConfigBoneSet1Compare = valueCompareList?.ElementAtOrDefault(1);
            animKitConfigBoneSet2Compare = valueCompareList?.ElementAtOrDefault(2);
            animKitConfigBoneSet3Compare = valueCompareList?.ElementAtOrDefault(3);
            animKitConfigBoneSet4Compare = valueCompareList?.ElementAtOrDefault(4);
            animKitConfigBoneSet5Compare = valueCompareList?.ElementAtOrDefault(5);
            animKitConfigBoneSet6Compare = valueCompareList?.ElementAtOrDefault(6);
            animKitConfigBoneSet7Compare = valueCompareList?.ElementAtOrDefault(7);
            animKitConfigBoneSet8Compare = valueCompareList?.ElementAtOrDefault(8);
        }
        else
        {
            animKitConfigBoneSet1Compare = null;
            animKitConfigBoneSet2Compare = null;
            animKitConfigBoneSet3Compare = null;
            animKitConfigBoneSet4Compare = null;
            animKitConfigBoneSet5Compare = null;
            animKitConfigBoneSet6Compare = null;
            animKitConfigBoneSet7Compare = null;
            animKitConfigBoneSet8Compare = null;
        }
    }

    void ValueChanged(byte newValue, AnimKitConfigBoneSet animKitConfigBoneSet)
    {
        animKitConfigBoneSet.AnimKitBoneSetID = newValue;
        var valueList = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);

        if(newValue == byte.MaxValue)
        {
            valueList.Remove(animKitConfigBoneSet);
        }
        else if (!valueList.Contains(animKitConfigBoneSet))
        {
            valueList.Add(animKitConfigBoneSet);
        }
    }

    AnimKitConfigBoneSet SetAndGetValue(int index)
    {
        var valueList = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);
        var value = valueList.ElementAtOrDefault(index);
        if (null == value)
        {
            value = new()
                {
                    AnimKitBoneSetID = byte.MaxValue
                };
        }
        return value;
    }

    async Task<Dictionary<byte, string>> GetAnimKitBoneSets()
    {
        var values = Enum.GetValues<AnimKitBoneSetId>().ToDictionary(key => (byte)key, value => value.ToDisplayString());
        values.Add(byte.MaxValue, "None");
        return values;
    }

    async Task<Dictionary<ushort, string>> GetAnimKitPriorities()
    {
        return Enum.GetValues<AnimKitPriorityId>()
        .ToDictionary(key => (ushort)key, value => value.ToDisplayString().Split()[1] + " " + value.ToDisplayString().Split()[0])
        .OrderBy(b => int.Parse(b.Value.Split(" ")[0]))
        .ToDictionary(x => x.Key, x => x.Value);
    }
}