@using HotfixMods.Core.Enums.Db2;
@using HotfixMods.Infrastructure.Blazor.Components.DtoContent

@inject AnimKitService Service

<InstancedDtoContentPage>
    <CustomDtoContent InstancedContent="true">
        <MudItem xs="3">
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet1.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet1Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet1.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet1))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet1Compare?.AnimKitPriorityID" GetOptionsAsync_Func="(Service.GetPriorityOptionsAsync)" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet2.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet2Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet2.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet2))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet2Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet3.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet3Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet3.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet3))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet3Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet4.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet4Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet4.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet4))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet4Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
        </MudItem>
        <MudItem xs="6" />
        <MudItem xs="3">
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet5.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet5Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet5.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet5))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet5Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet6.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet6Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet6.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet6))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet6Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet7.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet7Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet7.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet7))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet7Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
            <InlineGroup>
                <LeftContent>
                    <Input_Element T="byte" @bind-Value="@(animKitConfigBoneSet8.AnimKitBoneSetID)" Label="@("Bone Set ID")" ValueCompare="animKitConfigBoneSet8Compare?.AnimKitBoneSetID" GetOptionsAsync_Func="Service.GetBoneSetOptionsAsync" />
                </LeftContent>
                <RightContent>
                    <Input_Element T="ushort" Value="@(animKitConfigBoneSet8.AnimKitPriorityID)" ValueChanged="((ushort newValue) => PriorityChanged(newValue, animKitConfigBoneSet8))" Label="@("Priority ID")" ValueCompare="animKitConfigBoneSet8Compare?.AnimKitPriorityID" GetOptionsAsync_Func="GetPriorityOptionsWithDisabledAsync" />
                </RightContent>
            </InlineGroup>
        </MudItem>
    </CustomDtoContent>
</InstancedDtoContentPage>

@code {
    [CascadingParameter(Name = "InstanceData")]
    public InstanceData? InstanceData { get; set; }

    [CascadingParameter(Name = "GroupIndex")]
    public int GroupIndex { get; set; }

    [CascadingParameter(Name = "PageTab")]
    public PageTab PageTab { get; set; }

    [CascadingParameter(Name = "ValueIsNull")]
    public bool ValueIsNull { get; set; }


    bool valuesExists = false;

    AnimKitConfigBoneSet animKitConfigBoneSet1;
    AnimKitConfigBoneSet animKitConfigBoneSet2;
    AnimKitConfigBoneSet animKitConfigBoneSet3;
    AnimKitConfigBoneSet animKitConfigBoneSet4;
    AnimKitConfigBoneSet animKitConfigBoneSet5;
    AnimKitConfigBoneSet animKitConfigBoneSet6;
    AnimKitConfigBoneSet animKitConfigBoneSet7;
    AnimKitConfigBoneSet animKitConfigBoneSet8;

    AnimKitConfigBoneSet? animKitConfigBoneSet1Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet2Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet3Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet4Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet5Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet6Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet7Compare;
    AnimKitConfigBoneSet? animKitConfigBoneSet8Compare;

    protected override void OnParametersSet()
    {
        var groupValue = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);
        valuesExists = groupValue != null;
        if (valuesExists)
            SetValues();
        base.OnParametersSet();
    }

    void SetValues()
    {
        animKitConfigBoneSet1 = SetAndGetValue(0);
        animKitConfigBoneSet2 = SetAndGetValue(1);
        animKitConfigBoneSet3 = SetAndGetValue(2);
        animKitConfigBoneSet4 = SetAndGetValue(3);
        animKitConfigBoneSet5 = SetAndGetValue(4);
        animKitConfigBoneSet6 = SetAndGetValue(5);
        animKitConfigBoneSet7 = SetAndGetValue(6);
        animKitConfigBoneSet8 = SetAndGetValue(7);

        if (PageTab.DtoCompare != null)
        {
            var valueCompareList = PageTab.DtoCompare.GetDtoListValue<AnimKitConfigBoneSet>();
            animKitConfigBoneSet1Compare = valueCompareList?.ElementAtOrDefault(1);
            animKitConfigBoneSet2Compare = valueCompareList?.ElementAtOrDefault(2);
            animKitConfigBoneSet3Compare = valueCompareList?.ElementAtOrDefault(3);
            animKitConfigBoneSet4Compare = valueCompareList?.ElementAtOrDefault(4);
            animKitConfigBoneSet5Compare = valueCompareList?.ElementAtOrDefault(5);
            animKitConfigBoneSet6Compare = valueCompareList?.ElementAtOrDefault(6);
            animKitConfigBoneSet7Compare = valueCompareList?.ElementAtOrDefault(7);
            animKitConfigBoneSet8Compare = valueCompareList?.ElementAtOrDefault(8);
        }
        else
        {
            animKitConfigBoneSet1Compare = null;
            animKitConfigBoneSet2Compare = null;
            animKitConfigBoneSet3Compare = null;
            animKitConfigBoneSet4Compare = null;
            animKitConfigBoneSet5Compare = null;
            animKitConfigBoneSet6Compare = null;
            animKitConfigBoneSet7Compare = null;
            animKitConfigBoneSet8Compare = null;
        }
    }

    void PriorityChanged(ushort newValue, AnimKitConfigBoneSet animKitConfigBoneSet)
    {
        animKitConfigBoneSet.AnimKitPriorityID = newValue;
        var valueList = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);

        if (newValue == 0 && valueList[0] != animKitConfigBoneSet)
        {
            valueList.Remove(animKitConfigBoneSet);
        }
        else if (!valueList.Contains(animKitConfigBoneSet))
        {
            valueList.Add(animKitConfigBoneSet);
        }
    }

    AnimKitConfigBoneSet SetAndGetValue(int index)
    {
        var valueList = PageTab.Dto.GetDtoGroupListValue<AnimKitConfigBoneSet>(InstanceData.GroupType, GroupIndex);
        var value = valueList.ElementAtOrDefault(index);
        if (null == value)
        {
            value = new();
            if (index == 0)
            {
                value.AnimKitPriorityID = 1;
                valueList.Add(value);
            }
        }
        return value;
    }

    async Task<Dictionary<ushort, string>> GetPriorityOptionsWithDisabledAsync()
    {
        var options = new Dictionary<ushort, string>();
        options.Add(0, "Disabled");
        var clientOptions = await Service.GetPriorityOptionsAsync();
        foreach (var clientOption in clientOptions)
            options.Add(clientOption.Key, clientOption.Value);

        return options;
    }
}